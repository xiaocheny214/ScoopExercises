import{u as Ce,r as h,m as T,n as Ie,p as te,E as u,g as Se,k as P,a2 as oe,c as _,b as a,d as i,t as p,w as c,f as k,a3 as he,Q as j,R as z,K as B,q as Y,o as v,j as x,Y as Ae,h as R,a4 as W}from"./index-D6KW0YUS.js";import{u as be}from"./question-zwP50Slu.js";import{_ as ke}from"./_plugin-vue_export-helper-DlAUqK2U.js";const xe={class:"exam-container"},Te={class:"exam-header"},qe={class:"exam-info"},Ee={class:"exam-meta"},Ne={class:"exam-actions"},Le={class:"exam-content"},Ve={class:"question-area"},$e={class:"question-nav"},De={class:"nav-grid"},Qe=["onClick","title"],Ue={class:"question-content"},Me={key:0,class:"question-wrapper"},Oe={class:"question-header"},Pe={class:"question-number"},Be={class:"question-type"},Ye={class:"question-score"},He={class:"question-body"},Fe=["innerHTML"],je={key:0,class:"question-options"},ze={key:0,class:"multiple-choice-tip"},Re={class:"option-label"},We={class:"option-text"},Ke={class:"option-label"},Ge={class:"option-text"},Je={key:1,class:"question-input"},Xe={class:"input-tip"},Ze={key:2,class:"question-input"},et={class:"input-tip"},tt={class:"question-actions"},ot={class:"nav-buttons"},st={class:"submit-buttons"},nt={key:1,class:"no-question"},at={class:"submit-summary"},lt={key:0},rt={key:1},ut={__name:"Exam",setup(it){const A=Se(),m=be(),H=Ce(),E=h(!1),N=h(!1),Q=h(!1),L=h(3600),V=h(null),d=h(""),$=h([]),g=h([]),w=h([]),b=h([]),C=h([]),I=T(()=>m.currentPaper),f=T(()=>m.currentQuestionIndex),q=T(()=>g.value.length),y=T(()=>g.value[f.value]),K=T(()=>w.value.filter(t=>t&&t.trim()!=="").length),G=T(()=>C.value.filter(t=>t&&t.correct).length),J=T(()=>C.value.reduce((t,e)=>t+(e?e.score:0),0));Ie(f,t=>{const e=w.value[t]||"";d.value=e,g.value[t]&&U(g.value[t])?$.value=e?e.split(",").filter(n=>n.trim()):[]:$.value=[]},{immediate:!0});const se=t=>{const e=Math.floor(t/3600),n=Math.floor(t%3600/60),o=t%60;return e>0?`${e}:${n.toString().padStart(2,"0")}:${o.toString().padStart(2,"0")}`:`${n}:${o.toString().padStart(2,"0")}`},ne=()=>{I.value?.timeLimit?L.value=I.value.timeLimit*60:L.value=3600,V.value=setInterval(()=>{L.value--,L.value<=0&&(clearInterval(V.value),u.warning("考试时间已到，自动提交试卷"),ve())},1e3)},F=()=>{V.value&&(clearInterval(V.value),V.value=null)},ae=()=>{f.value>0&&m.currentQuestionIndex--},le=()=>{f.value<q.value-1&&m.currentQuestionIndex++},re=(t,e)=>{let n=`第${e+1}题 - ${t.questionTypeName||"题目"}`;if(C.value[e]){const o=C.value[e];n+=`
${o.correct?"✓ 正确":"✗ 错误"} (${o.score}分)`}else w.value[e]&&w.value[e].trim()!==""?n+=`
已答题`:n+=`
未答题`;return n},ue=t=>{t>=0&&t<q.value&&(m.currentQuestionIndex=t)},U=t=>!t||t.questionTypeCode!=="MULTIPLE_CHOICE"?!1:(t.correctAnswer||"").includes(","),ie=t=>{d.value=t.sort().join(",")},ce=(t,e)=>{if(!e||!e.trim())return"";switch(t.questionTypeCode){case"MULTIPLE_CHOICE":const n=e.trim().toUpperCase();return n.includes(",")?n.split(",").map(o=>o.trim()).filter(o=>o).sort().join(","):n;case"ANALYSIS":case"ESSAY":return e.trim();default:return e.trim()}},X=async()=>{const t=f.value,e=y.value;if(!e||!d.value||!d.value.trim()){u.warning("请先输入答案");return}if(b.value[t]){u.info("该题目已经提交过了");return}w.value[t]=d.value;let n=null;try{if(!e.id||!I.value.id){u.error("题目或试卷信息不完整，无法提交");return}if(n={userId:parseInt(H.userInfo?.id)||1,paperId:parseInt(I.value.id),questionType:e.questionTypeCode,questionId:parseInt(e.id),userAnswer:ce(e,d.value.trim())},isNaN(n.userId)||isNaN(n.paperId)||isNaN(n.questionId)){u.error("数据格式错误，请刷新页面重试"),console.error("数据类型错误:",n);return}console.log("提交答案数据:",n),console.log("数据类型检查:",{userId:typeof n.userId,paperId:typeof n.paperId,questionType:typeof n.questionType,questionId:typeof n.questionId,userAnswer:typeof n.userAnswer});const o=await P.post("/Answer/v1/submit",n);console.log("后端响应:",o),o.success?(u.success(`答案提交成功！${o.data.correct?"回答正确":"回答错误"}，得分：${o.data.scoreObtained}分`),o.data&&o.data.id?(b.value[t]=o.data.id,C.value[t]={correct:o.data.correct,score:o.data.scoreObtained,answerTime:o.data.answerTime},console.log("保存answerId:",o.data.id,"到索引:",t),console.log("答题结果:",C.value[t])):(b.value[t]=`temp_${Date.now()}_${t}`,console.log("使用临时ID标记已提交:",b.value[t])),console.log("提交结果详情:",o.data)):(console.error("提交失败，后端返回:",o),u.error(o.message||"提交答案失败"))}catch(o){console.error("提交答案失败，完整错误信息:",o),console.error("错误详情:",{message:o.message,response:o.response?.data,status:o.response?.status,submitData:n}),u.error("提交答案失败："+(o.response?.data?.message||o.message||o.msg||"网络错误"))}},de=()=>{N.value=!0},pe=async()=>{if(!Q.value){Q.value=!0;try{const t=b.value.filter(s=>s!=null);if(w.value.filter(s=>s&&s.trim()!=="").length===0){u.warning("请至少回答一道题目后再提交");return}if(t.length===0){u.warning("没有找到已提交的答案记录，请确保至少提交一道题目");return}if(!I.value.id||isNaN(parseInt(I.value.id))){u.error("试卷信息错误，请刷新页面重试");return}const n={userId:parseInt(H.userInfo?.id)||1,paperId:parseInt(I.value.id),answerIds:t.filter(s=>typeof s=="number"||typeof s=="string"&&!s.startsWith("temp_")).map(s=>parseInt(s))};console.log("提交试卷数据:",n),console.log("有效的answerIds:",t),console.log("过滤后的answerIds:",n.answerIds),console.log("当前用户答案状态:",w.value),console.log("当前answerIds状态:",b.value);const o=await P.post("/Answer/v1/paper",n);if(console.log("提交试卷响应:",o),o.success){const s=o.data,r={id:s.id||s.scoreId,totalScore:Number(s.totalScore||s.score||s.userScore||0),maxScore:Number(s.maxScore||s.total||s.fullScore||0),answeredCount:Number(s.answeredCount||s.answered||0),totalCount:Number(s.totalCount||s.questionCount||0)};console.log("=== 提交试卷成功 ==="),console.log("原始返回数据:",s),console.log("标准化后的数据:",r),console.log("数据类型检查:",{totalScore:typeof r.totalScore,maxScore:typeof r.maxScore,answeredCount:typeof r.answeredCount,totalCount:typeof r.totalCount}),u.success(`试卷提交成功！得分：${r.totalScore}/${r.maxScore}`),F(),m.resetAnswering(),A.push({path:"/score",query:{scoreId:r.id,totalScore:r.totalScore,maxScore:r.maxScore,answeredCount:r.answeredCount,totalCount:r.totalCount}})}else u.error(o.message||"提交试卷失败")}catch(t){console.error("提交试卷失败:",t),u.error("提交失败："+(t.message||t.msg||"网络错误"))}finally{Q.value=!1,N.value=!1}}},ve=async()=>{try{const t=f.value;d.value&&d.value.trim()&&!b.value[t]&&(console.log("自动提交前保存当前答案"),await X());const e=b.value.filter(s=>s!=null);if(e.length===0){u.warning("考试时间已到，但没有已提交的答案"),m.resetAnswering(),A.push("/home");return}const n={userId:parseInt(H.userInfo?.id)||1,paperId:parseInt(I.value.id),answerIds:e.filter(s=>typeof s=="number"||typeof s=="string"&&!s.startsWith("temp_")).map(s=>parseInt(s))};console.log("自动提交试卷数据:",n);const o=await P.post("/Answer/v1/paper",n);if(o.success){const s=o.data,r={id:s.id||s.scoreId,totalScore:Number(s.totalScore||s.score||s.userScore||0),maxScore:Number(s.maxScore||s.total||s.fullScore||0),answeredCount:Number(s.answeredCount||s.answered||0),totalCount:Number(s.totalCount||s.questionCount||0)};console.log("=== 自动提交成功 ==="),console.log("原始返回数据:",s),console.log("标准化后的数据:",r),u.info(`时间到！自动提交成功，得分：${r.totalScore}/${r.maxScore}`),m.resetAnswering(),A.push({path:"/score",query:{scoreId:r.id,totalScore:r.totalScore,maxScore:r.maxScore,answeredCount:r.answeredCount,totalCount:r.totalCount,autoSubmit:!0}})}else u.error("自动提交失败："+(o.message||"未知错误")),m.resetAnswering(),A.push("/home")}catch(t){console.error("自动提交失败:",t),u.error("自动提交失败"),m.resetAnswering(),A.push("/home")}},me=()=>{F(),m.resetAnswering(),A.push("/home"),E.value=!1};te(async()=>{if(console.log("答题页面初始化"),console.log("questionStore.isAnswering:",m.isAnswering),console.log("currentPaper:",m.currentPaper),!m.isAnswering||!m.currentPaper){console.log("没有正在进行的考试，跳转到首页"),u.warning("没有正在进行的考试"),A.push("/home");return}console.log("开始加载题目数据"),await fe();const t=w.value[f.value]||"";d.value=t,g.value[f.value]&&U(g.value[f.value])&&($.value=t?t.split(",").filter(e=>e.trim()):[]),ne(),console.log("答题页面初始化完成")});const fe=async()=>{try{console.log("开始加载试卷题目，试卷ID:",I.value.id);const t=await P.get(`/question/v1/list/paper/${I.value.id}`);if(console.log("后端返回的题目数据:",t),t.success||t.code===200){const e=t.data||[];console.log("原始题目列表:",e);const n=e.sort((o,s)=>o.questionTypeId!==s.questionTypeId?o.questionTypeId-s.questionTypeId:(o.sortOrder||0)-(s.sortOrder||0));console.log("排序后的题目:",n),g.value=n.map(o=>({...o,type:ge(o.questionTypeCode),options:ye(o),correctAnswer:_e(o)})),w.value=new Array(g.value.length).fill(""),b.value=new Array(g.value.length).fill(null),C.value=new Array(g.value.length).fill(null),console.log("题目加载成功，总数:",g.value.length),console.log("格式化后的题目:",g.value)}else console.error("加载题目失败，后端返回:",t),u.error(t.message||"加载题目失败"),A.push("/home")}catch(t){console.error("加载题目失败，错误详情:",t),u.error("加载题目失败："+(t.message||"网络错误")),A.push("/home")}},ge=t=>{switch(t){case"MULTIPLE_CHOICE":return"multiple-choice";case"ANALYSIS":return"analysis";case"ESSAY":return"essay";default:return"text"}},ye=t=>{if(t.questionTypeCode!=="MULTIPLE_CHOICE")return[];const e=[],n=t.details||{};console.log("格式化选项，题目数据:",t),console.log("details数据:",n);const o=n.optionA||t.optionA,s=n.optionB||t.optionB,r=n.optionC||t.optionC,M=n.optionD||t.optionD,O=n.optionE||t.optionE,D=n.optionF||t.optionF;return o&&e.push({key:"A",text:o}),s&&e.push({key:"B",text:s}),r&&e.push({key:"C",text:r}),M&&e.push({key:"D",text:M}),O&&e.push({key:"E",text:O}),D&&e.push({key:"F",text:D}),console.log("格式化后的选项:",e),e},_e=t=>{const e=t.details||{};switch(console.log("获取正确答案，题目类型:",t.questionTypeCode),console.log("details数据:",e),t.questionTypeCode){case"MULTIPLE_CHOICE":return e.correctAnswer||t.correctAnswer||"";case"ANALYSIS":return e.correctAnswer||t.correctAnswer||"";case"ESSAY":return e.referenceAnswer||t.referenceAnswer||"";default:return""}};oe(()=>{F()});const Z=t=>{m.isAnswering&&(t.preventDefault(),t.returnValue="考试正在进行中，确定要离开吗？")};return te(()=>{window.addEventListener("beforeunload",Z)}),oe(()=>{window.removeEventListener("beforeunload",Z)}),(t,e)=>{const n=k("el-button"),o=k("el-icon"),s=k("el-radio"),r=k("el-radio-group"),M=k("el-checkbox"),O=k("el-checkbox-group"),D=k("el-input"),we=k("el-empty"),ee=k("el-dialog");return v(),_("div",xe,[a("div",Te,[a("div",qe,[a("h2",null,p(I.value?.title||"答题中"),1),a("div",Ee,[a("span",null,"第 "+p(f.value+1)+" 题 / 共 "+p(q.value)+" 题",1),e[9]||(e[9]=a("span",{class:"divider"},"|",-1)),a("span",null,"剩余时间: "+p(se(L.value)),1)])]),a("div",Ne,[i(n,{onClick:e[0]||(e[0]=l=>E.value=!0)},{default:c(()=>[...e[10]||(e[10]=[x("退出考试",-1)])]),_:1}),i(n,{type:"primary",onClick:de},{default:c(()=>[...e[11]||(e[11]=[x("提交试卷",-1)])]),_:1})])]),a("div",Le,[a("div",Ve,[a("div",$e,[e[12]||(e[12]=he('<div class="nav-title" data-v-5a8d3e84>题目导航</div><div class="nav-legend" data-v-5a8d3e84><div class="legend-item" data-v-5a8d3e84><div class="legend-color unanswered" data-v-5a8d3e84></div><span data-v-5a8d3e84>未答</span></div><div class="legend-item" data-v-5a8d3e84><div class="legend-color answered" data-v-5a8d3e84></div><span data-v-5a8d3e84>已答</span></div><div class="legend-item" data-v-5a8d3e84><div class="legend-color correct" data-v-5a8d3e84></div><span data-v-5a8d3e84>正确</span></div><div class="legend-item" data-v-5a8d3e84><div class="legend-color incorrect" data-v-5a8d3e84></div><span data-v-5a8d3e84>错误</span></div><div class="legend-item" data-v-5a8d3e84><div class="legend-color current" data-v-5a8d3e84></div><span data-v-5a8d3e84>当前</span></div></div>',2)),a("div",De,[(v(!0),_(j,null,z(g.value,(l,S)=>(v(),_("div",{key:S,class:Ae(["nav-item",{active:S===f.value,answered:w.value[S]&&w.value[S].trim()!=="",correct:C.value[S]&&C.value[S].correct,incorrect:C.value[S]&&!C.value[S].correct,"multiple-choice":l.questionTypeCode==="MULTIPLE_CHOICE",analysis:l.questionTypeCode==="ANALYSIS",essay:l.questionTypeCode==="ESSAY"}]),onClick:ct=>ue(S),title:re(l,S)},p(S+1),11,Qe))),128))])]),a("div",Ue,[y.value?(v(),_("div",Me,[a("div",Oe,[a("span",Pe,"第 "+p(f.value+1)+" 题",1),a("span",Be,p(y.value.questionTypeName||"题目"),1),a("span",Ye,"("+p(y.value.score||0)+" 分)",1)]),a("div",He,[a("div",{class:"question-text",innerHTML:y.value.questionText||y.value.details?.questionText},null,8,Fe),y.value.type==="multiple-choice"?(v(),_("div",je,[U(y.value)?(v(),_("div",ze,[i(o,null,{default:c(()=>[i(R(W))]),_:1}),e[13]||(e[13]=a("span",null,"多选题：可以选择多个答案",-1))])):B("",!0),U(y.value)?(v(),Y(O,{key:2,modelValue:$.value,"onUpdate:modelValue":e[2]||(e[2]=l=>$.value=l),class:"option-group",onChange:ie},{default:c(()=>[(v(!0),_(j,null,z(y.value.options,l=>(v(),Y(M,{key:l.key,label:l.key,class:"option-item"},{default:c(()=>[a("span",Ke,p(l.key)+".",1),a("span",Ge,p(l.text),1)]),_:2},1032,["label"]))),128))]),_:1},8,["modelValue"])):(v(),Y(r,{key:1,modelValue:d.value,"onUpdate:modelValue":e[1]||(e[1]=l=>d.value=l),class:"option-group"},{default:c(()=>[(v(!0),_(j,null,z(y.value.options,l=>(v(),Y(s,{key:l.key,label:l.key,class:"option-item"},{default:c(()=>[a("span",Re,p(l.key)+".",1),a("span",We,p(l.text),1)]),_:2},1032,["label"]))),128))]),_:1},8,["modelValue"]))])):y.value.type==="analysis"?(v(),_("div",Je,[i(D,{modelValue:d.value,"onUpdate:modelValue":e[3]||(e[3]=l=>d.value=l),type:"textarea",rows:6,placeholder:"请输入你的分析...",class:"analysis-input"},null,8,["modelValue"]),a("div",Xe,[i(o,null,{default:c(()=>[i(R(W))]),_:1}),e[14]||(e[14]=a("span",null,"请根据题目要求进行分析，系统将根据关键词进行评分",-1))])])):y.value.type==="essay"?(v(),_("div",Ze,[i(D,{modelValue:d.value,"onUpdate:modelValue":e[4]||(e[4]=l=>d.value=l),type:"textarea",rows:8,placeholder:"请输入你的答案...",class:"essay-input"},null,8,["modelValue"]),a("div",et,[i(o,null,{default:c(()=>[i(R(W))]),_:1}),e[15]||(e[15]=a("span",null,"请详细回答问题，系统将根据答案内容进行评分",-1))])])):B("",!0)]),a("div",tt,[a("div",ot,[i(n,{onClick:ae,disabled:f.value===0},{default:c(()=>[...e[16]||(e[16]=[x(" 上一题 ",-1)])]),_:1},8,["disabled"]),i(n,{type:"primary",onClick:le,disabled:f.value===q.value-1},{default:c(()=>[...e[17]||(e[17]=[x(" 下一题 ",-1)])]),_:1},8,["disabled"])]),a("div",st,[i(n,{type:"success",onClick:X,disabled:!d.value||!d.value.trim()},{default:c(()=>[...e[18]||(e[18]=[x(" 提交答案 ",-1)])]),_:1},8,["disabled"])])])])):(v(),_("div",nt,[i(we,{description:"暂无题目数据"})]))])])]),i(ee,{modelValue:E.value,"onUpdate:modelValue":e[6]||(e[6]=l=>E.value=l),title:"退出确认",width:"400px"},{footer:c(()=>[i(n,{onClick:e[5]||(e[5]=l=>E.value=!1)},{default:c(()=>[...e[19]||(e[19]=[x("取消",-1)])]),_:1}),i(n,{type:"primary",onClick:me},{default:c(()=>[...e[20]||(e[20]=[x("确定退出",-1)])]),_:1})]),default:c(()=>[e[21]||(e[21]=a("p",null,"确定要退出考试吗？当前答题进度将会丢失。",-1))]),_:1},8,["modelValue"]),i(ee,{modelValue:N.value,"onUpdate:modelValue":e[8]||(e[8]=l=>N.value=l),title:"提交确认",width:"400px"},{footer:c(()=>[i(n,{onClick:e[7]||(e[7]=l=>N.value=!1)},{default:c(()=>[...e[23]||(e[23]=[x("取消",-1)])]),_:1}),i(n,{type:"primary",onClick:pe,loading:Q.value},{default:c(()=>[...e[24]||(e[24]=[x("确定提交",-1)])]),_:1},8,["loading"])]),default:c(()=>[a("div",null,[e[22]||(e[22]=a("p",null,"确定要提交试卷吗？",-1)),a("div",at,[a("p",null,"总题数："+p(q.value),1),a("p",null,"已答题："+p(K.value),1),a("p",null,"未答题："+p(q.value-K.value),1),G.value>0?(v(),_("p",lt,"正确题数："+p(G.value),1)):B("",!0),J.value>0?(v(),_("p",rt,"当前得分："+p(J.value)+"分",1)):B("",!0)])])]),_:1},8,["modelValue"])])}}},mt=ke(ut,[["__scopeId","data-v-5a8d3e84"]]);export{mt as default};
