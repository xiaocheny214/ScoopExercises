import{k as S,a5 as M,r as h}from"./index-D6KW0YUS.js";const y={getHistoryList(a={}){const c={page:a.page||0,size:a.size||10,userId:a.userId||null,paperId:a.paperId||null,bankId:a.bankId||null,startDate:a.startDate||null,endDate:a.endDate||null,orderBy:a.orderBy||"createTime",sortOrder:a.sortOrder||"DESC"};return S.post("/report/v1/scores",c)},getHistoryDetail(a){return S.get(`/report/v1/scores/${a}`)},deleteHistory(a){return S.delete(`/report/v1/scores/${a}`)},async batchDeleteHistory(a){const c=a.map(n=>S.delete(`/report/v1/scores/${n}`));try{const n=await Promise.allSettled(c);let l=0,i=0;const g=[];return n.forEach((d,m)=>{if(d.status==="fulfilled"&&d.value.success)l++;else{i++;const p=d.status==="rejected"?d.reason:d.value;g.push({id:a[m],error:p.message||"删除失败"})}}),{success:i===0,successCount:l,failCount:i,errors:g,message:i===0?`成功删除 ${l} 条记录`:`成功删除 ${l} 条记录，${i} 条记录删除失败`}}catch(n){return{success:!1,successCount:0,failCount:a.length,errors:[{error:n.message||"批量删除失败"}],message:"批量删除失败"}}},async exportHistory(a={}){try{const c=await this.getHistoryList({...a,size:1e3});return c.success?{success:!0,data:c.data.content,total:c.data.totalElements}:{success:!1,message:c.message||"导出失败"}}catch(c){return{success:!1,message:c.message||"导出失败"}}},async getHistoryStatistics(a={}){try{const c=await this.getHistoryList({...a,size:1e3});if(c.success){const n=c.data.content||[];if(n.length===0)return{success:!0,data:{totalCount:0,averageScore:0,highestScore:0,lowestScore:0,passRate:0,totalAnswered:0,totalQuestions:0}};const l=n.map(t=>t.score?.totalScore||0),i=n.map(t=>t.score?.maxScore||0),g=n.map(t=>{const r=t.score?.totalScore||0,o=t.score?.maxScore||0;return o>0?r/o*100:0}),d=l.reduce((t,r)=>t+r,0),m=i.reduce((t,r)=>t+r,0),p=m>0?d/m*100:0,C=Math.max(...g),x=Math.min(...g),D=g.filter(t=>t>=60).length/n.length*100,s=n.reduce((t,r)=>t+(r.score?.answeredCount||0),0),e=n.reduce((t,r)=>t+(r.score?.totalCount||0),0);return{success:!0,data:{totalCount:n.length,averageScore:Math.round(p*100)/100,highestScore:Math.round(C*100)/100,lowestScore:Math.round(x*100)/100,passRate:Math.round(D*100)/100,totalAnswered:s,totalQuestions:e}}}else return{success:!1,message:c.message||"获取统计信息失败"}}catch(c){return{success:!1,message:c.message||"获取统计信息失败"}}}},L=M("history",()=>{const a=h([]),c=h(null),n=h(!1),l=h({page:0,size:10,totalElements:0,totalPages:0});return{historyList:a,historyDetail:c,loading:n,pagination:l,getHistoryList:async(s={})=>{n.value=!0;try{const e=await y.getHistoryList(s);if(e.success){const t=e.data.content.map(r=>{const o=r.score||{};return{id:o.id,userId:o.userId,paperId:o.paperId,totalScore:o.totalScore||0,maxScore:o.maxScore||0,createTime:o.createTime,status:o.status,answeredCount:o.answeredCount||0,totalCount:o.totalCount||0,bankName:r.bankName||"未知题库",paperName:r.paperName||"未知试卷"}});return a.value=t,l.value={page:e.data.page,size:e.data.size,totalElements:e.data.totalElements,totalPages:e.data.totalPages},{success:!0,data:e.data}}else return{success:!1,message:e.message||"获取历史记录失败"}}catch(e){return console.error("获取历史记录失败:",e),{success:!1,message:e.message||"网络错误"}}finally{n.value=!1}},getHistoryDetail:async s=>{n.value=!0;try{const e=await y.getHistoryDetail(s);if(e.code===200||e.success){const t=e.data?.scoreInfo||{},r=e.data?.userAnswer||{},o={bankName:t.bankName||"未知题库",paperName:t.paperName||"未知试卷",score:{...t.score,bankName:t.bankName||"未知题库",paperName:t.paperName||"未知试卷"},userAnswer:{multipleChoice:r.multipleChoice||[],analysis:r.analysis||[],essay:r.essay||[]}};return c.value=o,console.log("处理后的详情数据:",o),console.log("原始响应数据:",e),{success:!0,data:o}}else return console.error("API 响应错误:",e),{success:!1,message:e.message||"获取详情失败"}}catch(e){return console.error("获取历史记录详情失败:",e),{success:!1,message:e.message||"网络错误"}}finally{n.value=!1}},deleteHistory:async s=>{try{const e=await y.deleteHistory(s);if(e.success){const t=a.value.findIndex(r=>r.id===s);return t>-1&&(a.value.splice(t,1),l.value.totalElements>0&&l.value.totalElements--),{success:!0,message:"删除成功"}}else return{success:!1,message:e.message||"删除失败"}}catch(e){return console.error("删除历史记录失败:",e),{success:!1,message:e.message||"网络错误"}}},batchDeleteHistory:async s=>{try{const e=await y.batchDeleteHistory(s);return(e.success||e.successCount>0)&&(s.forEach(t=>{const r=a.value.findIndex(o=>o.id===t);r>-1&&a.value.splice(r,1)}),e.successCount>0&&(l.value.totalElements=Math.max(0,l.value.totalElements-e.successCount))),{success:e.success,message:e.message,successCount:e.successCount,failCount:e.failCount}}catch(e){return console.error("批量删除历史记录失败:",e),{success:!1,message:e.message||"网络错误"}}},clearHistoryList:()=>{a.value=[],l.value={page:0,size:10,totalElements:0,totalPages:0}},clearHistoryDetail:()=>{c.value=null},filterHistoryList:s=>{let e=[...a.value];return s.bankId&&(e=e.filter(t=>t.bankId===s.bankId)),s.paperId&&(e=e.filter(t=>t.paperId===s.paperId)),s.startDate&&(e=e.filter(t=>new Date(t.createTime)>=new Date(s.startDate))),s.endDate&&(e=e.filter(t=>new Date(t.createTime)<=new Date(s.endDate))),s.minScore!==void 0&&(e=e.filter(t=>t.totalScore>=s.minScore)),s.maxScore!==void 0&&(e=e.filter(t=>t.totalScore<=s.maxScore)),e},getHistoryStatistics:()=>{const s=a.value;if(s.length===0)return{totalCount:0,averageScore:0,highestScore:0,lowestScore:0,passRate:0};const e=s.map(u=>u.totalScore),t=s.map(u=>u.maxScore),r=e.reduce((u,v)=>u+v,0),o=t.reduce((u,v)=>u+v,0),w=o>0?r/o*100:0,f=s.map(u=>u.maxScore>0?u.totalScore/u.maxScore*100:0),b=Math.max(...f),I=Math.min(...f),N=f.filter(u=>u>=60).length/s.length*100;return{totalCount:s.length,averageScore:Math.round(w*100)/100,highestScore:Math.round(b*100)/100,lowestScore:Math.round(I*100)/100,passRate:Math.round(N*100)/100}},exportHistoryData:(s=null)=>{let e=a.value;return s&&s.length>0&&(e=a.value.filter(t=>s.includes(t.id))),{exportTime:new Date().toISOString(),totalCount:e.length,data:e.map(t=>({id:t.id,bankName:t.bankName,paperName:t.paperName,totalScore:t.totalScore,maxScore:t.maxScore,percentage:t.maxScore>0?(t.totalScore/t.maxScore*100).toFixed(2)+"%":"0%",answeredCount:t.answeredCount,totalCount:t.totalCount,createTime:t.createTime,status:t.status}))}}}});export{y as h,L as u};
