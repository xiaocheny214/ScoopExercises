import{u as Se,r as h,m as x,n as oe,p as se,E as i,g as he,k as P,a2 as ne,c as _,b as a,d,t as p,w as v,f as A,a3 as Ee,Q as G,R as z,K as D,q as B,o as m,j as b,Y as Te,h as R,a4 as W}from"./index-BVGhpotA.js";import{u as Ae}from"./question-CTk_vUCp.js";import{_ as be}from"./_plugin-vue_export-helper-DlAUqK2U.js";const ke={class:"exam-container"},qe={class:"exam-header"},xe={class:"exam-info"},Le={class:"exam-meta"},Ne={class:"exam-actions"},$e={class:"exam-content"},Ue={class:"question-area"},Ve={class:"question-nav"},Oe={class:"nav-grid"},Me=["onClick","title"],Qe={class:"question-content"},He={key:0,class:"question-wrapper"},Pe={class:"question-header"},De={class:"question-number"},Be={class:"question-type"},Ye={class:"question-score"},je={class:"question-body"},Fe=["innerHTML"],Ge={key:0,class:"question-options"},ze={key:0,class:"multiple-choice-tip"},Re={class:"option-label"},We={class:"option-text"},Ke={class:"option-label"},Je={class:"option-text"},Xe={key:1,class:"question-input"},Ze={class:"input-tip"},et={key:2,class:"question-input"},tt={class:"input-tip"},ot={class:"question-actions"},st={class:"nav-buttons"},nt={class:"submit-buttons"},at={key:1,class:"no-question"},lt={class:"submit-summary"},rt={key:0},ut={key:1},it={__name:"Exam",setup(ct){const T=he(),f=Ae(),Y=Se(),N=h(!1),$=h(!1),M=h(!1),U=h(3600),V=h(null),c=h(""),w=h([]),C=h([]),u=h([]),k=h([]),E=h([]),I=x(()=>f.currentPaper),g=x(()=>f.currentQuestionIndex),L=x(()=>C.value.length),y=x(()=>C.value[g.value]),K=x(()=>u.value.filter(t=>t&&t.trim()!=="").length),J=x(()=>E.value.filter(t=>t&&t.correct).length),X=x(()=>E.value.reduce((t,e)=>t+(e?e.score:0),0));oe(c,t=>{const e=g.value,s=C.value[e];s&&e>=0&&e<u.value.length&&(s.questionTypeCode==="MULTIPLE_CHOICE"&&q(s)||(u.value[e]=t||""))}),oe(g,(t,e)=>{if(e!==void 0&&e>=0&&e<u.value.length){const o=C.value[e];o&&(o.questionTypeCode==="MULTIPLE_CHOICE"&&q(o)?u.value[e]=w.value.sort().join(","):u.value[e]=c.value||"")}const s=u.value[t]||"",n=C.value[t];n?n.questionTypeCode==="MULTIPLE_CHOICE"&&q(n)?(w.value=s?s.split(",").filter(o=>o.trim()):[],c.value=s):(c.value=s,w.value=[]):(c.value=s,w.value=[])},{immediate:!0});const ae=t=>{const e=Math.floor(t/3600),s=Math.floor(t%3600/60),n=t%60;return e>0?`${e}:${s.toString().padStart(2,"0")}:${n.toString().padStart(2,"0")}`:`${s}:${n.toString().padStart(2,"0")}`},le=()=>{I.value?.timeLimit?U.value=I.value.timeLimit*60:U.value=3600,V.value=setInterval(()=>{U.value--,U.value<=0&&(clearInterval(V.value),i.warning("考试时间已到，自动提交试卷"),fe())},1e3)},j=()=>{V.value&&(clearInterval(V.value),V.value=null)},re=()=>{g.value>0&&(F(),f.currentQuestionIndex--)},ue=()=>{g.value<L.value-1&&(F(),f.currentQuestionIndex++)},ie=(t,e)=>{let s=`第${e+1}题 - ${t.questionTypeName||"题目"}`;if(E.value[e]){const n=E.value[e];s+=`
${n.correct?"✓ 正确":"✗ 错误"} (${n.score}分)`}else u.value[e]&&u.value[e].trim()!==""?s+=`
已答题`:s+=`
未答题`;return s},ce=t=>{t>=0&&t<L.value&&(F(),f.currentQuestionIndex=t)},F=()=>{const t=g.value,e=C.value[t];t>=0&&t<u.value.length&&e&&(e.questionTypeCode==="MULTIPLE_CHOICE"&&q(e)?u.value[t]=w.value.sort().join(","):u.value[t]=c.value||"",console.log(`保存题目${t+1}答案:`,u.value[t]),console.log(`题目类型: ${e.questionTypeCode}`))},q=t=>!(!t||t.questionTypeCode!=="MULTIPLE_CHOICE"),de=t=>{const e=t.sort().join(",");c.value=e;const s=g.value;s>=0&&s<u.value.length&&(u.value[s]=e),console.log("多选题答案变化:",t,"-> ",e)},ve=(t,e)=>{if(!e||!e.trim())return"";switch(t.questionTypeCode){case"SINGLE_CHOICE":const s=e.trim().toUpperCase();return/^[A-F]$/.test(s)?s:"";case"MULTIPLE_CHOICE":const n=e.trim().toUpperCase();return n.includes(",")?n.split(",").map(o=>o.trim()).filter(o=>o).sort().join(","):n;case"ANALYSIS":case"ESSAY":return e.trim();default:return e.trim()}},Z=async()=>{const t=g.value,e=y.value;if(!e){i.warning("题目信息不完整");return}let s="";if(e.questionTypeCode==="MULTIPLE_CHOICE"&&q(e)?s=w.value.sort().join(","):s=c.value||"",!s||!s.trim()){i.warning("请先输入答案");return}if(k.value[t]){i.info("该题目已经提交过了");return}u.value[t]=s;let n=null;try{if(!e.id||!I.value.id){i.error("题目或试卷信息不完整，无法提交");return}if(n={userId:parseInt(Y.userInfo?.id)||1,paperId:parseInt(I.value.id),questionType:e.questionTypeCode,questionId:parseInt(e.id),userAnswer:ve(e,s.trim())},isNaN(n.userId)||isNaN(n.paperId)||isNaN(n.questionId)){i.error("数据格式错误，请刷新页面重试");return}const o=await P.post("/Answer/v1/submit",n);o.success?(i.success(`答案提交成功！${o.data.correct?"回答正确":"回答错误"}，得分：${o.data.scoreObtained}分`),o.data&&o.data.id?(k.value[t]=o.data.id,E.value[t]={correct:o.data.correct,score:o.data.scoreObtained,answerTime:o.data.answerTime}):k.value[t]=`temp_${Date.now()}_${t}`):i.error(o.message||"提交答案失败")}catch(o){i.error("提交答案失败："+(o.response?.data?.message||o.message||o.msg||"网络错误"))}},pe=()=>{$.value=!0},me=async()=>{if(!M.value){M.value=!0;try{const t=k.value.filter(o=>o!=null);if(u.value.filter(o=>o&&o.trim()!=="").length===0){i.warning("请至少回答一道题目后再提交");return}if(t.length===0){i.warning("没有找到已提交的答案记录，请确保至少提交一道题目");return}if(!I.value.id||isNaN(parseInt(I.value.id))){i.error("试卷信息错误，请刷新页面重试");return}const s={userId:parseInt(Y.userInfo?.id)||1,paperId:parseInt(I.value.id),answerIds:t.filter(o=>typeof o=="number"||typeof o=="string"&&!o.startsWith("temp_")).map(o=>parseInt(o))};console.log("提交试卷数据:",s),console.log("有效的answerIds:",t),console.log("过滤后的answerIds:",s.answerIds),console.log("当前用户答案状态:",u.value),console.log("当前answerIds状态:",k.value);const n=await P.post("/Answer/v1/paper",s);if(console.log("提交试卷响应:",n),n.success){const o=n.data,r={id:o.id||o.scoreId,totalScore:Number(o.totalScore||o.score||o.userScore||0),maxScore:Number(o.maxScore||o.total||o.fullScore||0),answeredCount:Number(o.answeredCount||o.answered||0),totalCount:Number(o.totalCount||o.questionCount||0)};console.log("=== 提交试卷成功 ==="),console.log("原始返回数据:",o),console.log("标准化后的数据:",r),console.log("数据类型检查:",{totalScore:typeof r.totalScore,maxScore:typeof r.maxScore,answeredCount:typeof r.answeredCount,totalCount:typeof r.totalCount}),i.success(`试卷提交成功！得分：${r.totalScore}/${r.maxScore}`),j(),f.resetAnswering(),T.push({path:"/score",query:{scoreId:r.id,totalScore:r.totalScore,maxScore:r.maxScore,answeredCount:r.answeredCount,totalCount:r.totalCount}})}else i.error(n.message||"提交试卷失败")}catch(t){console.error("提交试卷失败:",t),i.error("提交失败："+(t.message||t.msg||"网络错误"))}finally{M.value=!1,$.value=!1}}},fe=async()=>{try{const t=g.value;c.value&&c.value.trim()&&!k.value[t]&&(console.log("自动提交前保存当前答案"),await Z());const e=k.value.filter(o=>o!=null);if(e.length===0){i.warning("考试时间已到，但没有已提交的答案"),f.resetAnswering(),T.push("/home");return}const s={userId:parseInt(Y.userInfo?.id)||1,paperId:parseInt(I.value.id),answerIds:e.filter(o=>typeof o=="number"||typeof o=="string"&&!o.startsWith("temp_")).map(o=>parseInt(o))};console.log("自动提交试卷数据:",s);const n=await P.post("/Answer/v1/paper",s);if(n.success){const o=n.data,r={id:o.id||o.scoreId,totalScore:Number(o.totalScore||o.score||o.userScore||0),maxScore:Number(o.maxScore||o.total||o.fullScore||0),answeredCount:Number(o.answeredCount||o.answered||0),totalCount:Number(o.totalCount||o.questionCount||0)};console.log("=== 自动提交成功 ==="),console.log("原始返回数据:",o),console.log("标准化后的数据:",r),i.info(`时间到！自动提交成功，得分：${r.totalScore}/${r.maxScore}`),f.resetAnswering(),T.push({path:"/score",query:{scoreId:r.id,totalScore:r.totalScore,maxScore:r.maxScore,answeredCount:r.answeredCount,totalCount:r.totalCount,autoSubmit:!0}})}else i.error("自动提交失败："+(n.message||"未知错误")),f.resetAnswering(),T.push("/home")}catch(t){console.error("自动提交失败:",t),i.error("自动提交失败"),f.resetAnswering(),T.push("/home")}},ge=()=>{j(),f.resetAnswering(),T.push("/home"),N.value=!1};se(async()=>{if(console.log("答题页面初始化"),console.log("questionStore.isAnswering:",f.isAnswering),console.log("currentPaper:",f.currentPaper),!f.isAnswering||!f.currentPaper){console.log("没有正在进行的考试，跳转到首页"),i.warning("没有正在进行的考试"),T.push("/home");return}console.log("开始加载题目数据"),await Ce();const t=g.value,e=u.value[t]||"",s=C.value[t];s?s.questionTypeCode==="MULTIPLE_CHOICE"&&q(s)?(w.value=e?e.split(",").filter(n=>n.trim()):[],c.value=e):(c.value=e,w.value=[]):(c.value=e,w.value=[]),le(),console.log("答题页面初始化完成")});const Ce=async()=>{try{console.log("开始加载试卷题目，试卷ID:",I.value.id);const t=await P.get(`/question/v1/list/paper/${I.value.id}`);if(console.log("后端返回的题目数据:",t),t.success||t.code===200){const e=t.data||[];console.log("原始题目列表:",e);const s=e.sort((n,o)=>n.questionTypeId!==o.questionTypeId?n.questionTypeId-o.questionTypeId:(n.sortOrder||0)-(o.sortOrder||0));console.log("排序后的题目:",s),C.value=s.map(n=>({...n,type:ye(n.questionTypeCode),options:_e(n),correctAnswer:we(n)})),u.value=new Array(C.value.length).fill(""),k.value=new Array(C.value.length).fill(null),E.value=new Array(C.value.length).fill(null),console.log("题目加载成功，总数:",C.value.length),console.log("格式化后的题目:",C.value)}else console.error("加载题目失败，后端返回:",t),i.error(t.message||"加载题目失败"),T.push("/home")}catch(t){console.error("加载题目失败，错误详情:",t),i.error("加载题目失败："+(t.message||"网络错误")),T.push("/home")}},ye=t=>{switch(t){case"SINGLE_CHOICE":return"single-choice";case"MULTIPLE_CHOICE":return"multiple-choice";case"ANALYSIS":return"analysis";case"ESSAY":return"essay";default:return"text"}},_e=t=>{if(t.questionTypeCode!=="SINGLE_CHOICE"&&t.questionTypeCode!=="MULTIPLE_CHOICE")return[];const e=[],s=t.details||{};console.log("格式化选项，题目数据:",t),console.log("details数据:",s);const n=s.optionA||t.optionA,o=s.optionB||t.optionB,r=s.optionC||t.optionC,Q=s.optionD||t.optionD,H=s.optionE||t.optionE,O=s.optionF||t.optionF;return n&&e.push({key:"A",text:n}),o&&e.push({key:"B",text:o}),r&&e.push({key:"C",text:r}),Q&&e.push({key:"D",text:Q}),H&&e.push({key:"E",text:H}),O&&e.push({key:"F",text:O}),console.log("格式化后的选项:",e),e},we=t=>{const e=t.details||{};switch(console.log("获取正确答案，题目类型:",t.questionTypeCode),console.log("details数据:",e),t.questionTypeCode){case"SINGLE_CHOICE":case"MULTIPLE_CHOICE":return e.correctAnswer||t.correctAnswer||"";case"ANALYSIS":return e.correctAnswer||t.correctAnswer||"";case"ESSAY":return e.referenceAnswer||t.referenceAnswer||"";default:return""}};ne(()=>{j()});const ee=t=>{f.isAnswering&&(t.preventDefault(),t.returnValue="考试正在进行中，确定要离开吗？")};return se(()=>{window.addEventListener("beforeunload",ee)}),ne(()=>{window.removeEventListener("beforeunload",ee)}),(t,e)=>{const s=A("el-button"),n=A("el-icon"),o=A("el-radio"),r=A("el-radio-group"),Q=A("el-checkbox"),H=A("el-checkbox-group"),O=A("el-input"),Ie=A("el-empty"),te=A("el-dialog");return m(),_("div",ke,[a("div",qe,[a("div",xe,[a("h2",null,p(I.value?.title||"答题中"),1),a("div",Le,[a("span",null,"第 "+p(g.value+1)+" 题 / 共 "+p(L.value)+" 题",1),e[9]||(e[9]=a("span",{class:"divider"},"|",-1)),a("span",null,"剩余时间: "+p(ae(U.value)),1)])]),a("div",Ne,[d(s,{onClick:e[0]||(e[0]=l=>N.value=!0)},{default:v(()=>[...e[10]||(e[10]=[b("退出考试",-1)])]),_:1}),d(s,{type:"primary",onClick:pe},{default:v(()=>[...e[11]||(e[11]=[b("提交试卷",-1)])]),_:1})])]),a("div",$e,[a("div",Ue,[a("div",Ve,[e[12]||(e[12]=Ee('<div class="nav-title" data-v-8e6f4e34>题目导航</div><div class="nav-legend" data-v-8e6f4e34><div class="legend-item" data-v-8e6f4e34><div class="legend-color unanswered" data-v-8e6f4e34></div><span data-v-8e6f4e34>未答</span></div><div class="legend-item" data-v-8e6f4e34><div class="legend-color answered" data-v-8e6f4e34></div><span data-v-8e6f4e34>已答</span></div><div class="legend-item" data-v-8e6f4e34><div class="legend-color correct" data-v-8e6f4e34></div><span data-v-8e6f4e34>正确</span></div><div class="legend-item" data-v-8e6f4e34><div class="legend-color incorrect" data-v-8e6f4e34></div><span data-v-8e6f4e34>错误</span></div><div class="legend-item" data-v-8e6f4e34><div class="legend-color current" data-v-8e6f4e34></div><span data-v-8e6f4e34>当前</span></div></div>',2)),a("div",Oe,[(m(!0),_(G,null,z(C.value,(l,S)=>(m(),_("div",{key:S,class:Te(["nav-item",{active:S===g.value,answered:u.value[S]&&u.value[S].trim()!=="",correct:E.value[S]&&E.value[S].correct,incorrect:E.value[S]&&!E.value[S].correct,"single-choice":l.questionTypeCode==="SINGLE_CHOICE","multiple-choice":l.questionTypeCode==="MULTIPLE_CHOICE",analysis:l.questionTypeCode==="ANALYSIS",essay:l.questionTypeCode==="ESSAY"}]),onClick:dt=>ce(S),title:ie(l,S)},p(S+1),11,Me))),128))])]),a("div",Qe,[y.value?(m(),_("div",He,[a("div",Pe,[a("span",De,"第 "+p(g.value+1)+" 题",1),a("span",Be,p(y.value.questionTypeName||"题目"),1),a("span",Ye,"("+p(y.value.score||0)+" 分)",1)]),a("div",je,[a("div",{class:"question-text",innerHTML:y.value.questionText||y.value.details?.questionText},null,8,Fe),y.value.type==="single-choice"||y.value.type==="multiple-choice"?(m(),_("div",Ge,[q(y.value)?(m(),_("div",ze,[d(n,null,{default:v(()=>[d(R(W))]),_:1}),e[13]||(e[13]=a("span",null,"多选题：可以选择多个答案",-1))])):D("",!0),q(y.value)?(m(),B(H,{key:2,modelValue:w.value,"onUpdate:modelValue":e[2]||(e[2]=l=>w.value=l),class:"option-group",onChange:de},{default:v(()=>[(m(!0),_(G,null,z(y.value.options,l=>(m(),B(Q,{key:l.key,label:l.key,class:"option-item"},{default:v(()=>[a("span",Ke,p(l.key)+".",1),a("span",Je,p(l.text),1)]),_:2},1032,["label"]))),128))]),_:1},8,["modelValue"])):(m(),B(r,{key:1,modelValue:c.value,"onUpdate:modelValue":e[1]||(e[1]=l=>c.value=l),class:"option-group"},{default:v(()=>[(m(!0),_(G,null,z(y.value.options,l=>(m(),B(o,{key:l.key,label:l.key,class:"option-item"},{default:v(()=>[a("span",Re,p(l.key)+".",1),a("span",We,p(l.text),1)]),_:2},1032,["label"]))),128))]),_:1},8,["modelValue"]))])):y.value.type==="analysis"?(m(),_("div",Xe,[d(O,{modelValue:c.value,"onUpdate:modelValue":e[3]||(e[3]=l=>c.value=l),type:"textarea",rows:6,placeholder:"请输入你的分析...",class:"analysis-input"},null,8,["modelValue"]),a("div",Ze,[d(n,null,{default:v(()=>[d(R(W))]),_:1}),e[14]||(e[14]=a("span",null,"请根据题目要求进行分析，系统将根据关键词进行评分",-1))])])):y.value.type==="essay"?(m(),_("div",et,[d(O,{modelValue:c.value,"onUpdate:modelValue":e[4]||(e[4]=l=>c.value=l),type:"textarea",rows:8,placeholder:"请输入你的答案...",class:"essay-input"},null,8,["modelValue"]),a("div",tt,[d(n,null,{default:v(()=>[d(R(W))]),_:1}),e[15]||(e[15]=a("span",null,"请详细回答问题，系统将根据答案内容进行评分",-1))])])):D("",!0)]),a("div",ot,[a("div",st,[d(s,{onClick:re,disabled:g.value===0},{default:v(()=>[...e[16]||(e[16]=[b(" 上一题 ",-1)])]),_:1},8,["disabled"]),d(s,{type:"primary",onClick:ue,disabled:g.value===L.value-1},{default:v(()=>[...e[17]||(e[17]=[b(" 下一题 ",-1)])]),_:1},8,["disabled"])]),a("div",nt,[d(s,{type:"success",onClick:Z,disabled:!c.value||!c.value.trim()},{default:v(()=>[...e[18]||(e[18]=[b(" 提交答案 ",-1)])]),_:1},8,["disabled"])])])])):(m(),_("div",at,[d(Ie,{description:"暂无题目数据"})]))])])]),d(te,{modelValue:N.value,"onUpdate:modelValue":e[6]||(e[6]=l=>N.value=l),title:"退出确认",width:"400px"},{footer:v(()=>[d(s,{onClick:e[5]||(e[5]=l=>N.value=!1)},{default:v(()=>[...e[19]||(e[19]=[b("取消",-1)])]),_:1}),d(s,{type:"primary",onClick:ge},{default:v(()=>[...e[20]||(e[20]=[b("确定退出",-1)])]),_:1})]),default:v(()=>[e[21]||(e[21]=a("p",null,"确定要退出考试吗？当前答题进度将会丢失。",-1))]),_:1},8,["modelValue"]),d(te,{modelValue:$.value,"onUpdate:modelValue":e[8]||(e[8]=l=>$.value=l),title:"提交确认",width:"400px"},{footer:v(()=>[d(s,{onClick:e[7]||(e[7]=l=>$.value=!1)},{default:v(()=>[...e[23]||(e[23]=[b("取消",-1)])]),_:1}),d(s,{type:"primary",onClick:me,loading:M.value},{default:v(()=>[...e[24]||(e[24]=[b("确定提交",-1)])]),_:1},8,["loading"])]),default:v(()=>[a("div",null,[e[22]||(e[22]=a("p",null,"确定要提交试卷吗？",-1)),a("div",lt,[a("p",null,"总题数："+p(L.value),1),a("p",null,"已答题："+p(K.value),1),a("p",null,"未答题："+p(L.value-K.value),1),J.value>0?(m(),_("p",rt,"正确题数："+p(J.value),1)):D("",!0),X.value>0?(m(),_("p",ut,"当前得分："+p(X.value)+"分",1)):D("",!0)])])]),_:1},8,["modelValue"])])}}},ft=be(it,[["__scopeId","data-v-8e6f4e34"]]);export{ft as default};
