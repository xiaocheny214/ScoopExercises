import{k as S,a5 as k,r as h}from"./index-BVGhpotA.js";const y={getHistoryList(a={}){const o={page:a.page||0,size:a.size||10,userId:a.userId||null,paperId:a.paperId||null,bankId:a.bankId||null,startDate:a.startDate||null,endDate:a.endDate||null,orderBy:a.orderBy||"createTime",sortOrder:a.sortOrder||"DESC"};return S.post("/report/v1/scores",o)},getHistoryDetail(a){return S.get(`/report/v1/scores/${a}`)},deleteHistory(a){return S.delete(`/report/v1/scores/${a}`)},async batchDeleteHistory(a){const o=a.map(c=>S.delete(`/report/v1/scores/${c}`));try{const c=await Promise.allSettled(o);let l=0,i=0;const m=[];return c.forEach((d,p)=>{if(d.status==="fulfilled"&&d.value.success)l++;else{i++;const g=d.status==="rejected"?d.reason:d.value;m.push({id:a[p],error:g.message||"删除失败"})}}),{success:i===0,successCount:l,failCount:i,errors:m,message:i===0?`成功删除 ${l} 条记录`:`成功删除 ${l} 条记录，${i} 条记录删除失败`}}catch(c){return{success:!1,successCount:0,failCount:a.length,errors:[{error:c.message||"批量删除失败"}],message:"批量删除失败"}}},async exportHistory(a={}){try{const o=await this.getHistoryList({...a,size:1e3});return o.success?{success:!0,data:o.data.content,total:o.data.totalElements}:{success:!1,message:o.message||"导出失败"}}catch(o){return{success:!1,message:o.message||"导出失败"}}},async getHistoryStatistics(a={}){try{const o=await this.getHistoryList({...a,size:1e3});if(o.success){const c=o.data.content||[];if(c.length===0)return{success:!0,data:{totalCount:0,averageScore:0,highestScore:0,lowestScore:0,passRate:0,totalAnswered:0,totalQuestions:0}};const l=c.map(e=>e.score?.totalScore||0),i=c.map(e=>e.score?.maxScore||0),m=c.map(e=>{const r=e.score?.totalScore||0,n=e.score?.maxScore||0;return n>0?r/n*100:0}),d=l.reduce((e,r)=>e+r,0),p=i.reduce((e,r)=>e+r,0),g=p>0?d/p*100:0,x=Math.max(...m),C=Math.min(...m),D=m.filter(e=>e>=60).length/c.length*100,s=c.reduce((e,r)=>e+(r.score?.answeredCount||0),0),t=c.reduce((e,r)=>e+(r.score?.totalCount||0),0);return{success:!0,data:{totalCount:c.length,averageScore:Math.round(g*100)/100,highestScore:Math.round(x*100)/100,lowestScore:Math.round(C*100)/100,passRate:Math.round(D*100)/100,totalAnswered:s,totalQuestions:t}}}else return{success:!1,message:o.message||"获取统计信息失败"}}catch(o){return{success:!1,message:o.message||"获取统计信息失败"}}}},T=k("history",()=>{const a=h([]),o=h(null),c=h(!1),l=h({page:0,size:10,totalElements:0,totalPages:0});return{historyList:a,historyDetail:o,loading:c,pagination:l,getHistoryList:async(s={})=>{c.value=!0;try{const t=await y.getHistoryList(s);if(t.success){const e=t.data.content.map(r=>{const n=r.score||{};return{id:n.id,userId:n.userId,paperId:n.paperId,totalScore:n.totalScore||0,maxScore:n.maxScore||0,createTime:n.createTime,status:n.status,answeredCount:n.answeredCount||0,totalCount:n.totalCount||0,bankName:r.bankName||"未知题库",paperName:r.paperName||"未知试卷"}});return a.value=e,l.value={page:t.data.page,size:t.data.size,totalElements:t.data.totalElements,totalPages:t.data.totalPages},{success:!0,data:t.data}}else return{success:!1,message:t.message||"获取历史记录失败"}}catch(t){return console.error("获取历史记录失败:",t),{success:!1,message:t.message||"网络错误"}}finally{c.value=!1}},getHistoryDetail:async s=>{c.value=!0;try{const t=await y.getHistoryDetail(s);if(t.code===200||t.success){const e=t.data?.scoreInfo||{},r=t.data?.userAnswer||{},n={bankName:t.data?.bankName||e.bankName||"未知题库",paperName:t.data?.paperName||e.paperName||"未知试卷",score:{id:e.score?.id,userId:e.score?.userId,paperId:e.score?.paperId,totalScore:e.score?.totalScore||e.score?.obtainedScore||0,maxScore:e.score?.totalScore||0,createTime:e.score?.createTime,updateTime:e.score?.updateTime,accuracyRate:e.score?.accuracyRate,attemptNum:e.score?.attemptNum,bankName:t.data?.bankName||e.bankName||"未知题库",paperName:t.data?.paperName||e.paperName||"未知试卷"},userAnswer:{multipleChoice:r.multipleChoice||[],analysis:r.analysis||[],essay:r.essay||[]},statistics:t.data?.statistics||{}};return o.value=n,{success:!0,data:n}}else return console.error("API 响应错误:",t),{success:!1,message:t.message||"获取详情失败"}}catch(t){return console.error("获取历史记录详情失败:",t),{success:!1,message:t.message||"网络错误"}}finally{c.value=!1}},deleteHistory:async s=>{try{const t=await y.deleteHistory(s);if(t.success){const e=a.value.findIndex(r=>r.id===s);return e>-1&&(a.value.splice(e,1),l.value.totalElements>0&&l.value.totalElements--),{success:!0,message:"删除成功"}}else return{success:!1,message:t.message||"删除失败"}}catch(t){return console.error("删除历史记录失败:",t),{success:!1,message:t.message||"网络错误"}}},batchDeleteHistory:async s=>{try{const t=await y.batchDeleteHistory(s);return(t.success||t.successCount>0)&&(s.forEach(e=>{const r=a.value.findIndex(n=>n.id===e);r>-1&&a.value.splice(r,1)}),t.successCount>0&&(l.value.totalElements=Math.max(0,l.value.totalElements-t.successCount))),{success:t.success,message:t.message,successCount:t.successCount,failCount:t.failCount}}catch(t){return console.error("批量删除历史记录失败:",t),{success:!1,message:t.message||"网络错误"}}},clearHistoryList:()=>{a.value=[],l.value={page:0,size:10,totalElements:0,totalPages:0}},clearHistoryDetail:()=>{o.value=null},filterHistoryList:s=>{let t=[...a.value];return s.bankId&&(t=t.filter(e=>e.bankId===s.bankId)),s.paperId&&(t=t.filter(e=>e.paperId===s.paperId)),s.startDate&&(t=t.filter(e=>new Date(e.createTime)>=new Date(s.startDate))),s.endDate&&(t=t.filter(e=>new Date(e.createTime)<=new Date(s.endDate))),s.minScore!==void 0&&(t=t.filter(e=>e.totalScore>=s.minScore)),s.maxScore!==void 0&&(t=t.filter(e=>e.totalScore<=s.maxScore)),t},getHistoryStatistics:()=>{const s=a.value;if(s.length===0)return{totalCount:0,averageScore:0,highestScore:0,lowestScore:0,passRate:0};const t=s.map(u=>u.totalScore),e=s.map(u=>u.maxScore),r=t.reduce((u,v)=>u+v,0),n=e.reduce((u,v)=>u+v,0),w=n>0?r/n*100:0,f=s.map(u=>u.maxScore>0?u.totalScore/u.maxScore*100:0),N=Math.max(...f),b=Math.min(...f),I=f.filter(u=>u>=60).length/s.length*100;return{totalCount:s.length,averageScore:Math.round(w*100)/100,highestScore:Math.round(N*100)/100,lowestScore:Math.round(b*100)/100,passRate:Math.round(I*100)/100}},exportHistoryData:(s=null)=>{let t=a.value;return s&&s.length>0&&(t=a.value.filter(e=>s.includes(e.id))),{exportTime:new Date().toISOString(),totalCount:t.length,data:t.map(e=>({id:e.id,bankName:e.bankName,paperName:e.paperName,totalScore:e.totalScore,maxScore:e.maxScore,percentage:e.maxScore>0?(e.totalScore/e.maxScore*100).toFixed(2)+"%":"0%",answeredCount:e.answeredCount,totalCount:e.totalCount,createTime:e.createTime,status:e.status}))}}}});export{y as h,T as u};
